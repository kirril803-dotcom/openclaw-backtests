//@version=6
indicator('Classic Dow Theory Market Structure', overlay=true, max_lines_count=500, max_labels_count=500)
// ══════════════════════════════════════════════════════════════════════════════════════════════════
//
// --- Inputs ---
group_zz = "ZigZag Settings"
i_dev_thresh_inp = input.float(3, 'Deviation Multiplier', minval=0, tooltip="Multiplier for ATR deviation.", group=group_zz)
i_depth = input.int(11, 'Depth', minval=1, group=group_zz)
c_zz = input.color(color.new(color.gray, 50), "ZigZag Line Color", group=group_zz)
i_zzStyle = input.string("Dashed", "ZigZag Line Style", options=["Solid", "Dashed", "Dotted"], group=group_zz)
group_ms = "Market Structure Settings"
i_showLabels = input.bool(true, "Show Swing Labels (HH, HL, LH, LL)", group=group_ms)
c_up = input.color(#4caf50, "Bullish Structure Color", group=group_ms)
c_dn = input.color(#f44336, "Bearish Structure Color", group=group_ms)
// ══════════════════════════════════════════════════════════════════════════════════════════════════
//
// --- Core ZigZag Variables ---
var line lineLast = na
var int iLast = 0
var float pLast = 0.
var bool isHighLast = false
// Translate string input to Pine style format
zz_style_parsed = i_zzStyle == "Solid" ? line.style_solid : i_zzStyle == "Dotted" ? line.style_dotted : line.style_dashed
// --- Market Structure Variables ---
var float locked_H = na
var float prev_locked_H = na
var float locked_L = na
var float prev_locked_L = na
var label active_lbl = na
var line line_HL = na // Support line from Higher Low
var line line_LH = na // Resistance line from Lower High
// ══════════════════════════════════════════════════════════════════════════════════════════════════
//
// --- Pivot Calculations ---
i_dev_thresh = ta.atr(10) / close * 100 * i_dev_thresh_inp
pivots(src, length, isHigh) =>
    l2 = length * 2
    c = nz(src[length])
    ok = true
    for i = 0 to l2 by 1
        if isHigh and src[i] > c
            ok := false
        if not isHigh and src[i] < c
            ok := false
    if ok
        [bar_index[length], c]
    else
        [int(na), float(na)]
[iH, pH] = pivots(high, i_depth / 2, true )
[iL, pL] = pivots(low , i_depth / 2, false)
calc_dev(base_price, price) => 100 * (price - base_price) / price
pivotFound(dev, isHigh, index, price) =>
    if isHighLast == isHigh and not na(lineLast)
        if isHighLast ? price > pLast : price < pLast
            line.set_xy2(lineLast, index, price)
            [lineLast, isHighLast]
        else
            [line(na), bool(na)]
    else if math.abs(dev) > i_dev_thresh
        id = line.new(iLast, pLast, index, price, color=c_zz, width=1, style=zz_style_parsed)
        [id, isHigh]
    else
        [line(na), bool(na)]
// ══════════════════════════════════════════════════════════════════════════════════════════════════
//
// --- Dow Theory Logic ---
// Process Highs
if not na(iH)
    dev = calc_dev(pLast, pH)
    [id, isHigh] = pivotFound(dev, true, iH, pH)
    if not na(id)
        if id != lineLast
            // Direction changed from Down to Up -> The ACTIVE LOW is now LOCKED
            prev_locked_L := locked_L
            locked_L := pLast
            // Label the locked Low permanently
            string txtL = na(prev_locked_L) ? "L" : (locked_L > prev_locked_L ? "HL" : "LL")
            if i_showLabels
                label.new(iLast, pLast, txtL, style=label.style_label_up, textcolor=c_dn, color=color.new(color.white, 100), size=size.small)
            // Dow Theory: If it's a Higher Low, draw support to watch for a trend
            if txtL == "HL"
                line.delete(line_HL)
                line_HL := line.new(iLast, pLast, bar_index, pLast, color=c_dn, style=line.style_solid, extend=extend.right)
        // Start tracking the new High
        string txtH = na(locked_H) ? "H" : (pH > locked_H ? "HH" : "LH")
        if i_showLabels
            active_lbl := label.new(iH, pH, txtH, style=label.style_label_down, textcolor=c_up, color=color.new(color.white, 100), size=size.small)
        else
            // Still going Up -> Update the tentative High
            string txtH = na(locked_H) ? "H" : (pH > locked_H ? "HH" : "LH")
            if i_showLabels
                label.set_xy(active_lbl, iH, pH)
                label.set_text(active_lbl, txtH)
        lineLast := id
        isHighLast := isHigh
        iLast := iH
        pLast := pH
// Process Lows
else if not na(iL)
    dev = calc_dev(pLast, pL)
    [id, isHigh] = pivotFound(dev, false, iL, pL)
    if not na(id)
        if id != lineLast
            // Direction changed from Up to Down -> The ACTIVE HIGH is now LOCKED
            prev_locked_H := locked_H
            locked_H := pLast
            // Label the locked High permanently
            string txtH = na(prev_locked_H) ? "H" : (locked_H > prev_locked_H ? "HH" : "LH")
            if i_showLabels
                label.new(iLast, pLast, txtH, style=label.style_label_down, textcolor=c_up, color=color.new(color.white, 100), size=size.small)
            // Dow Theory: If it's a Lower High, draw resistance to watch for a trend
            if txtH == "LH"
                line.delete(line_LH)
                line_LH := line.new(iLast, pLast, bar_index, pLast, color=c_up, style=line.style_solid, extend=extend.right)
        // Start tracking the new Low
        string txtL = na(locked_L) ? "L" : (pL < locked_L ? "LL" : "HL")
        if i_showLabels
            active_lbl := label.new(iL, pL, txtL, style=label.style_label_up, textcolor=c_dn, color=color.new(color.white, 100), size=size.small)
        else
            // Still going Down -> Update the tentative Low
            string txtL = na(locked_L) ? "L" : (pL < locked_L ? "LL" : "HL")
            if i_showLabels
                label.set_xy(active_lbl, iL, pL)
                label.set_text(active_lbl, txtL)
        lineLast := id
        isHighLast := isHigh
        iLast := iL
        pLast := pL
// ══════════════════════════════════════════════════════════════════════════════════════════════════
//
// --- Reversal Detection ---
// Break of Lower High ends Downtrend -> Uptrend Confirmed
if not na(line_LH) and close > line.get_y1(line_LH)
    line.set_extend(line_LH, extend.none)
    line.set_x2(line_LH, bar_index)
    label.new(bar_index, line.get_y1(line_LH), "Break of LH\nEnds Downtrend", style=label.style_label_down, textcolor=c_up, color=color.new(color.white, 100), size=size.small)
    line_LH := na // Clear the line so it doesn't trigger again
// Break of Higher Low ends Uptrend -> Downtrend Confirmed
if not na(line_HL) and close < line.get_y1(line_HL)
    line.set_extend(line_HL, extend.none)
    line.set_x2(line_HL, bar_index)
    label.new(bar_index, line.get_y1(line_HL), "Break of HL\nEnds Uptrend", style=label.style_label_up, textcolor=c_dn, color=color.new(color.white, 100), size=size.small)
    line_HL := na
